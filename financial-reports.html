<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports - MediSupply Hub</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2c5530; --primary-light: #4a7856; --secondary: #f8f9fa;
            --accent: #e63946; --text: #333; --text-light: #6c757d; --border: #dee2e6;
            --success: #28a745; --warning: #ffc107; --danger: #dc3545;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: var(--text); }
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem; }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .nav-logo h1 { color: var(--primary); font-size: 1.2rem; }
        .nav-menu { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .nav-link { text-decoration: none; color: var(--text); padding: 0.5rem 0.75rem; border-radius: 4px; transition: all 0.3s ease; font-size: 0.9rem; }
        .nav-link:hover, .nav-link.active { background: var(--primary); color: white; }
        .main-content { max-width: 1400px; margin: 1rem auto; padding: 0 1rem; }
        .report-section { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .filters { background: var(--secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .filter-group { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .filter-group select, .filter-group input { padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; }
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 0.8rem; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background: var(--secondary); font-weight: 600; }
        .amount { text-align: right; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .summary-card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .summary-card h3 { color: var(--text-light); font-size: 0.8rem; margin-bottom: 0.5rem; }
        .summary-card .value { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        @media (max-width: 768px) {
            .nav-menu { justify-content: center; }
            .filter-group { flex-direction: column; }
            .report-summary { grid-template-columns: 1fr 1fr; }
            .report-section { padding: 1rem; }
        }
        @media (max-width: 480px) {
            .nav-logo h1 { font-size: 1rem; }
            .nav-link { padding: 0.4rem 0.6rem; font-size: 0.8rem; }
            .main-content { padding: 0 0.5rem; }
            .report-summary { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo"><h1>üè• MediSupply Accounting</h1></div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Dashboard</a>
                <a href="chart-of-accounts.html" class="nav-link">Accounts</a>
                <a href="journal-entries.html" class="nav-link">Journal</a>
                <a href="general-ledger.html" class="nav-link">Ledger</a>
                <a href="invoices.html" class="nav-link">Sales</a>
                <a href="expenses.html" class="nav-link">Expenses</a>
                <a href="inventory.html" class="nav-link">Inventory</a>
                <a href="financial-reports.html" class="nav-link active">Reports</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <h2 style="margin-bottom: 1.5rem;">Financial Reports</h2>

        <div class="filters">
            <div class="filter-group">
                <select id="report-type">
                    <option value="balance-sheet">Balance Sheet</option>
                    <option value="income-statement">Income Statement</option>
                    <option value="cash-flow">Cash Flow Statement</option>
                </select>
                <input type="month" id="report-month" value="">
                <button class="btn btn-primary" onclick="loadFinancialReports()">Generate Report</button>
                <button class="btn" onclick="printReport()" style="background: var(--secondary);">Print Report</button>
            </div>
        </div>

        <div class="report-summary" id="report-summary">
            <!-- Summary cards will be loaded here -->
        </div>

        <div class="report-section">
            <h3 id="report-title">Balance Sheet</h3>
            <div id="balance-sheet-report">
                <!-- Balance sheet will be loaded here -->
            </div>
            <div id="income-statement-report" style="display: none;">
                <!-- Income statement will be loaded here -->
            </div>
            <div id="cash-flow-report" style="display: none;">
                <!-- Cash flow statement will be loaded here -->
            </div>
        </div>
    </main>

    <script src="firebase-config.js"></script>
    <script>
        function setDefaultMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('report-month').value = year + '-' + month;
        }

        function loadFinancialReports() {
            const reportType = document.getElementById('report-type').value;
            const reportMonth = document.getElementById('report-month').value;

            // Hide all reports first
            document.getElementById('balance-sheet-report').style.display = 'none';
            document.getElementById('income-statement-report').style.display = 'none';
            document.getElementById('cash-flow-report').style.display = 'none';

            if (reportType === 'balance-sheet') {
                loadBalanceSheet();
                document.getElementById('balance-sheet-report').style.display = 'block';
                document.getElementById('report-title').textContent = 'Balance Sheet - As of ' + new Date().toLocaleDateString();
            } else if (reportType === 'income-statement') {
                loadIncomeStatement(reportMonth);
                document.getElementById('income-statement-report').style.display = 'block';
                document.getElementById('report-title').textContent = 'Income Statement - ' + new Date(reportMonth + '-01').toLocaleDateString('en', {year: 'numeric', month: 'long'});
            } else if (reportType === 'cash-flow') {
                loadCashFlowStatement(reportMonth);
                document.getElementById('cash-flow-report').style.display = 'block';
                document.getElementById('report-title').textContent = 'Cash Flow Statement - ' + new Date(reportMonth + '-01').toLocaleDateString('en', {year: 'numeric', month: 'long'});
            }
        }

        function loadBalanceSheet() {
            let totalAssets = 0;
            let totalLiabilities = 0;
            let totalEquity = 0;

            db.collection('companies').doc(COMPANY_ID).collection('chart_of_accounts')
                .get()
                .then(snapshot => {
                    const assets = [];
                    const liabilities = [];
                    const equity = [];
                    let revenueTotal = 0;
                    let expenseTotal = 0;

                    snapshot.forEach(doc => {
                        const account = doc.data();
                        if (account.type === 'asset') {
                            assets.push(account);
                            totalAssets += account.balance || 0;
                        } else if (account.type === 'liability') {
                            liabilities.push(account);
                            totalLiabilities += account.balance || 0;
                        } else if (account.type === 'equity') {
                            equity.push(account);
                            totalEquity += account.balance || 0;
                        } else if (account.type === 'revenue') {
                            revenueTotal += account.balance || 0;
                        } else if (account.type === 'expense') {
                            expenseTotal += account.balance || 0;
                        }
                    });

                    const netIncome = revenueTotal - expenseTotal;
                    const totalEquityWithIncome = totalEquity + netIncome;

                    // Update summary
                    document.getElementById('report-summary').innerHTML = 
                        '<div class="summary-card"><h3>Total Assets</h3><div class="value">‚Ç¶' + totalAssets.toLocaleString() + '</div></div>' +
                        '<div class="summary-card"><h3>Total Liabilities</h3><div class="value">‚Ç¶' + totalLiabilities.toLocaleString() + '</div></div>' +
                        '<div class="summary-card"><h3>Total Equity</h3><div class="value">‚Ç¶' + totalEquityWithIncome.toLocaleString() + '</div></div>' +
                        '<div class="summary-card"><h3>Net Income</h3><div class="value ' + (netIncome >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + netIncome.toLocaleString() + '</div></div>';

                    // Build balance sheet HTML
                    let balanceSheetHTML = '<table><tr><th>Assets</th><th class="amount">Amount</th></tr>';
                    
                    assets.forEach(account => {
                        if (account.balance !== 0) {
                            balanceSheetHTML += '<tr><td>' + account.name + '</td><td class="amount">‚Ç¶' + (account.balance || 0).toLocaleString() + '</td></tr>';
                        }
                    });
                    
                    balanceSheetHTML += '<tr><td><strong>Total Assets</strong></td><td class="amount"><strong>‚Ç¶' + totalAssets.toLocaleString() + '</strong></td></tr>';
                    
                    balanceSheetHTML += '</table><table><tr><th>Liabilities & Equity</th><th class="amount">Amount</th></tr>';
                    
                    liabilities.forEach(account => {
                        if (account.balance !== 0) {
                            balanceSheetHTML += '<tr><td>' + account.name + '</td><td class="amount">‚Ç¶' + (account.balance || 0).toLocaleString() + '</td></tr>';
                        }
                    });
                    
                    balanceSheetHTML += '<tr><td><strong>Total Liabilities</strong></td><td class="amount"><strong>‚Ç¶' + totalLiabilities.toLocaleString() + '</strong></td></tr>';
                    balanceSheetHTML += '<tr><td><strong>Equity</strong></td><td class="amount"></td></tr>';
                    
                    equity.forEach(account => {
                        if (account.balance !== 0) {
                            balanceSheetHTML += '<tr><td>' + account.name + '</td><td class="amount">‚Ç¶' + (account.balance || 0).toLocaleString() + '</td></tr>';
                        }
                    });
                    
                    balanceSheetHTML += '<tr><td>Retained Earnings (Net Income)</td><td class="amount">‚Ç¶' + netIncome.toLocaleString() + '</td></tr>';
                    balanceSheetHTML += '<tr><td><strong>Total Equity</strong></td><td class="amount"><strong>‚Ç¶' + totalEquityWithIncome.toLocaleString() + '</strong></td></tr>';
                    balanceSheetHTML += '<tr><td><strong>Total Liabilities & Equity</strong></td><td class="amount"><strong>‚Ç¶' + (totalLiabilities + totalEquityWithIncome).toLocaleString() + '</strong></td></tr>';
                    
                    balanceSheetHTML += '</table>';
                    
                    const equationBalanced = Math.abs(totalAssets - (totalLiabilities + totalEquityWithIncome)) < 0.01;
                    balanceSheetHTML += '<div style="margin-top: 1rem; padding: 1rem; background: ' + (equationBalanced ? '#d4edda' : '#f8d7da') + '; color: ' + (equationBalanced ? '#155724' : '#721c24') + '; border-radius: 4px; text-align: center; font-weight: bold;">' +
                        'Accounting Equation: ' + (equationBalanced ? 'BALANCED ‚úì' : 'UNBALANCED ‚úó') + '</div>';

                    document.getElementById('balance-sheet-report').innerHTML = balanceSheetHTML;
                });
        }

        function loadIncomeStatement(month) {
            const [year, monthNum] = month.split('-');
            const startDate = new Date(year, monthNum - 1, 1);
            const endDate = new Date(year, monthNum, 0);
            endDate.setHours(23, 59, 59, 999);

            let totalRevenue = 0;
            let totalCOGS = 0;
            let totalExpenses = 0;

            // Calculate revenue from invoices
            db.collection('companies').doc(COMPANY_ID).collection('invoices')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get()
                .then(invoiceSnapshot => {
                    invoiceSnapshot.forEach(doc => {
                        totalRevenue += doc.data().totalAmount || 0;
                    });

                    // Calculate COGS and expenses from journal entries
                    db.collection('companies').doc(COMPANY_ID).collection('journal_entries')
                        .where('date', '>=', startDate)
                        .where('date', '<=', endDate)
                        .get()
                        .then(journalSnapshot => {
                            journalSnapshot.forEach(doc => {
                                const entry = doc.data();
                                entry.lineItems.forEach(item => {
                                    if (item.accountType === 'expense') {
                                        if (item.accountCode === '5001') { // COGS
                                            totalCOGS += item.amount;
                                        } else {
                                            totalExpenses += item.amount;
                                        }
                                    }
                                });
                            });

                            const grossProfit = totalRevenue - totalCOGS;
                            const operatingIncome = grossProfit - totalExpenses;
                            const netIncome = operatingIncome; // Assuming no taxes/other income for simplicity

                            // Update summary
                            document.getElementById('report-summary').innerHTML = 
                                '<div class="summary-card"><h3>Total Revenue</h3><div class="value">‚Ç¶' + totalRevenue.toLocaleString() + '</div></div>' +
                                '<div class="summary-card"><h3>Gross Profit</h3><div class="value ' + (grossProfit >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + grossProfit.toLocaleString() + '</div></div>' +
                                '<div class="summary-card"><h3>Operating Income</h3><div class="value ' + (operatingIncome >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + operatingIncome.toLocaleString() + '</div></div>' +
                                '<div class="summary-card"><h3>Net Income</h3><div class="value ' + (netIncome >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + netIncome.toLocaleString() + '</div></div>';

                            // Build income statement HTML
                            let incomeHTML = '<table>';
                            incomeHTML += '<tr><td><strong>Revenue</strong></td><td class="amount"></td></tr>';
                            incomeHTML += '<tr><td>Medical Supplies Sales</td><td class="amount">‚Ç¶' + totalRevenue.toLocaleString() + '</td></tr>';
                            incomeHTML += '<tr><td><strong>Total Revenue</strong></td><td class="amount"><strong>‚Ç¶' + totalRevenue.toLocaleString() + '</strong></td></tr>';
                            
                            incomeHTML += '<tr><td><strong>Cost of Goods Sold</strong></td><td class="amount"></td></tr>';
                            incomeHTML += '<tr><td>Cost of Medical Supplies</td><td class="amount">‚Ç¶' + totalCOGS.toLocaleString() + '</td></tr>';
                            incomeHTML += '<tr><td><strong>Total COGS</strong></td><td class="amount"><strong>‚Ç¶' + totalCOGS.toLocaleString() + '</strong></td></tr>';
                            
                            incomeHTML += '<tr><td><strong>Gross Profit</strong></td><td class="amount"><strong>‚Ç¶' + grossProfit.toLocaleString() + '</strong></td></tr>';
                            
                            incomeHTML += '<tr><td><strong>Operating Expenses</strong></td><td class="amount"></td></tr>';
                            incomeHTML += '<tr><td>All Operating Expenses</td><td class="amount">‚Ç¶' + totalExpenses.toLocaleString() + '</td></tr>';
                            incomeHTML += '<tr><td><strong>Total Operating Expenses</strong></td><td class="amount"><strong>‚Ç¶' + totalExpenses.toLocaleString() + '</strong></td></tr>';
                            
                            incomeHTML += '<tr><td><strong>Net Income</strong></td><td class="amount"><strong class="' + (netIncome >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + netIncome.toLocaleString() + '</strong></td></tr>';
                            incomeHTML += '</table>';

                            document.getElementById('income-statement-report').innerHTML = incomeHTML;
                        });
                });
        }

        function loadCashFlowStatement(month) {
            const [year, monthNum] = month.split('-');
            const startDate = new Date(year, monthNum - 1, 1);
            const endDate = new Date(year, monthNum, 0);
            endDate.setHours(23, 59, 59, 999);

            let cashFromOperations = 0;
            let cashFromInvesting = 0;
            let cashFromFinancing = 0;

            // Simplified cash flow calculation
            db.collection('companies').doc(COMPANY_ID).collection('journal_entries')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const entry = doc.data();
                        entry.lineItems.forEach(item => {
                            if (item.accountCode === '1001') { // Cash account
                                if (item.debit > 0) {
                                    // Cash inflow
                                    cashFromOperations += item.debit;
                                } else if (item.credit > 0) {
                                    // Cash outflow
                                    cashFromOperations -= item.credit;
                                }
                            }
                        });
                    });

                    const netCashFlow = cashFromOperations + cashFromInvesting + cashFromFinancing;

                    // Update summary
                    document.getElementById('report-summary').innerHTML = 
                        '<div class="summary-card"><h3>Cash from Operations</h3><div class="value ' + (cashFromOperations >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + cashFromOperations.toLocaleString() + '</div></div>' +
                        '<div class="summary-card"><h3>Cash from Investing</h3><div class="value">‚Ç¶' + cashFromInvesting.toLocaleString() + '</div></div>' +
                        '<div class="summary-card"><h3>Cash from Financing</h3><div class="value">‚Ç¶' + cashFromFinancing.toLocaleString() + '</div></div>' +
                        '<div class="summary-card"><h3>Net Cash Flow</h3><div class="value ' + (netCashFlow >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + netCashFlow.toLocaleString() + '</div></div>';

                    // Build cash flow statement HTML
                    let cashFlowHTML = '<table>';
                    cashFlowHTML += '<tr><td><strong>Cash flows from operating activities:</strong></td><td class="amount"></td></tr>';
                    cashFlowHTML += '<tr><td>Net cash provided by operations</td><td class="amount">‚Ç¶' + cashFromOperations.toLocaleString() + '</td></tr>';
                    cashFlowHTML += '<tr><td><strong>Net cash from operations</strong></td><td class="amount"><strong class="' + (cashFromOperations >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + cashFromOperations.toLocaleString() + '</strong></td></tr>';
                    
                    cashFlowHTML += '<tr><td><strong>Cash flows from investing activities:</strong></td><td class="amount"></td></tr>';
                    cashFlowHTML += '<tr><td>Net cash from investing</td><td class="amount">‚Ç¶' + cashFromInvesting.toLocaleString() + '</td></tr>';
                    cashFlowHTML += '<tr><td><strong>Net cash from investing</strong></td><td class="amount"><strong>‚Ç¶' + cashFromInvesting.toLocaleString() + '</strong></td></tr>';
                    
                    cashFlowHTML += '<tr><td><strong>Cash flows from financing activities:</strong></td><td class="amount"></td></tr>';
                    cashFlowHTML += '<tr><td>Net cash from financing</td><td class="amount">‚Ç¶' + cashFromFinancing.toLocaleString() + '</td></tr>';
                    cashFlowHTML += '<tr><td><strong>Net cash from financing</strong></td><td class="amount"><strong>‚Ç¶' + cashFromFinancing.toLocaleString() + '</strong></td></tr>';
                    
                    cashFlowHTML += '<tr><td><strong>Net increase in cash</strong></td><td class="amount"><strong class="' + (netCashFlow >= 0 ? 'positive' : 'negative') + '">‚Ç¶' + netCashFlow.toLocaleString() + '</strong></td></tr>';
                    cashFlowHTML += '</table>';

                    document.getElementById('cash-flow-report').innerHTML = cashFlowHTML;
                });
        }

        function printReport() {
            window.print();
        }

        document.addEventListener('DOMContentLoaded', function() {
            setDefaultMonth();
            loadFinancialReports();
        });
    </script>
</body>
</html>
