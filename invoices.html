<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Invoices - MediSupply Hub</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2c5530; --primary-light: #4a7856; --secondary: #f8f9fa;
            --accent: #e63946; --text: #333; --text-light: #6c757d; --border: #dee2e6;
            --success: #28a745; --warning: #ffc107; --danger: #dc3545;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: var(--text); }
        .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 2rem; }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .nav-logo h1 { color: var(--primary); }
        .nav-menu { display: flex; gap: 1rem; flex-wrap: wrap; }
        .nav-link { text-decoration: none; color: var(--text); padding: 0.5rem 1rem; border-radius: 4px; transition: all 0.3s ease; }
        .nav-link:hover, .nav-link.active { background: var(--primary); color: white; }
        .main-content { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--secondary); font-weight: 600; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: var(--text); border: 1px solid var(--border); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 2% auto; padding: 2rem; border-radius: 8px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; }
        .invoice-item { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end; }
        .invoice-total { text-align: right; font-size: 1.2rem; margin: 1rem 0; padding: 1rem; background: var(--secondary); border-radius: 4px; }
        .status-paid { background: #d1edff; color: #004085; padding: 0.25rem 0.75rem; border-radius: 20px; }
        .status-pending { background: #fff3cd; color: #856404; padding: 0.25rem 0.75rem; border-radius: 20px; }
        .sales-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-card .amount { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        @media (max-width: 768px) {
            .navbar { padding: 1rem; }
            .nav-container { flex-direction: column; gap: 1rem; }
            .nav-menu { justify-content: center; }
            .main-content { padding: 0 1rem; }
            .invoice-item { grid-template-columns: 1fr; gap: 0.5rem; }
            .sales-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo"><h1>üè• MediSupply Hub Accounting</h1></div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Dashboard</a>
                <a href="chart-of-accounts.html" class="nav-link">Chart of Accounts</a>
                <a href="journal-entries.html" class="nav-link">Journal Entries</a>
                <a href="general-ledger.html" class="nav-link">General Ledger</a>
                <a href="invoices.html" class="nav-link active">Invoices</a>
                <a href="expenses.html" class="nav-link">Expenses</a>
                <a href="inventory.html" class="nav-link">Inventory</a>
                <a href="financial-reports.html" class="nav-link">Reports</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <h2>Sales Invoices</h2>
            <button class="btn btn-primary" onclick="showInvoiceForm()">+ Create Invoice</button>
        </div>

        <div class="sales-stats">
            <div class="stat-card">
                <h3>Total Sales Today</h3>
                <div class="amount" id="sales-today">‚Ç¶0</div>
            </div>
            <div class="stat-card">
                <h3>Total Sales This Month</h3>
                <div class="amount" id="sales-month">‚Ç¶0</div>
            </div>
            <div class="stat-card">
                <h3>Pending Invoices</h3>
                <div class="amount" id="pending-invoices">0</div>
            </div>
            <div class="stat-card">
                <h3>Average Invoice Value</h3>
                <div class="amount" id="average-invoice">‚Ç¶0</div>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Items</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="invoices-table">
                    <!-- Invoices will be loaded here -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content">
            <span style="float: right; font-size: 1.5rem; cursor: pointer;" onclick="hideInvoiceForm()">&times;</span>
            <h3>Create Sales Invoice</h3>
            <form id="invoice-form">
                <div class="form-group">
                    <label for="invoice-customer">Customer Name</label>
                    <input type="text" id="invoice-customer" required>
                </div>
                <div class="form-group">
                    <label for="invoice-date">Date</label>
                    <input type="date" id="invoice-date" required>
                </div>

                <h4>Items</h4>
                <div id="invoice-items-container">
                    <div class="invoice-item">
                        <select class="invoice-product" required onchange="updateItemPrice(this)">
                            <option value="">Select Product</option>
                        </select>
                        <input type="number" class="invoice-quantity" placeholder="Qty" min="1" value="1" required oninput="calculateItemTotal(this)">
                        <input type="number" class="invoice-price" placeholder="Price" step="0.01" required oninput="calculateItemTotal(this)">
                        <span class="item-total">‚Ç¶0.00</span>
                        <button type="button" class="btn-secondary" onclick="removeInvoiceItem(this)">Remove</button>
                    </div>
                </div>
                <button type="button" class="btn-secondary" onclick="addInvoiceItem()">+ Add Item</button>

                <div class="invoice-total">
                    <strong>Total: ‚Ç¶<span id="invoice-total-amount">0.00</span></strong>
                </div>

                <div class="form-actions" style="margin-top: 1rem; text-align: right;">
                    <button type="button" class="btn-secondary" onclick="hideInvoiceForm()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let products = [];

        function loadProducts() {
            db.collection('companies').doc(COMPANY_ID).collection('products')
                .orderBy('name')
                .get()
                .then(snapshot => {
                    products = [];
                    const selects = document.querySelectorAll('.invoice-product');
                    selects.forEach(select => {
                        select.innerHTML = '<option value="">Select Product</option>';
                    });

                    snapshot.forEach(doc => {
                        const product = doc.data();
                        product.id = doc.id;
                        products.push(product);
                        
                        selects.forEach(select => {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = product.name + ' (Stock: ' + product.stockQuantity + ')';
                            option.dataset.price = product.sellingPrice;
                            select.appendChild(option);
                        });
                    });
                });
        }

        function showInvoiceForm() {
            document.getElementById('invoice-modal').style.display = 'block';
            document.getElementById('invoice-date').valueAsDate = new Date();
            document.getElementById('invoice-customer').value = 'Walk-in Customer';
            loadProducts();
            calculateInvoiceTotal();
        }

        function hideInvoiceForm() {
            document.getElementById('invoice-modal').style.display = 'none';
            document.getElementById('invoice-form').reset();
        }

        function addInvoiceItem() {
            const container = document.getElementById('invoice-items-container');
            const newItem = document.createElement('div');
            newItem.className = 'invoice-item';
            newItem.innerHTML = '<select class="invoice-product" required onchange="updateItemPrice(this)">' +
                '<option value="">Select Product</option>' +
                '</select>' +
                '<input type="number" class="invoice-quantity" placeholder="Qty" min="1" value="1" required oninput="calculateItemTotal(this)">' +
                '<input type="number" class="invoice-price" placeholder="Price" step="0.01" required oninput="calculateItemTotal(this)">' +
                '<span class="item-total">‚Ç¶0.00</span>' +
                '<button type="button" class="btn-secondary" onclick="removeInvoiceItem(this)">Remove</button>';
            container.appendChild(newItem);
            
            // Populate products for new select
            const select = newItem.querySelector('.invoice-product');
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name + ' (Stock: ' + product.stockQuantity + ')';
                option.dataset.price = product.sellingPrice;
                select.appendChild(option);
            });
        }

        function removeInvoiceItem(button) {
            if (document.querySelectorAll('.invoice-item').length > 1) {
                button.closest('.invoice-item').remove();
                calculateInvoiceTotal();
            }
        }

        function updateItemPrice(select) {
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.dataset.price) {
                const priceInput = select.closest('.invoice-item').querySelector('.invoice-price');
                priceInput.value = selectedOption.dataset.price;
                calculateItemTotal(select);
            }
        }

        function calculateItemTotal(input) {
            const item = input.closest('.invoice-item');
            const quantity = parseFloat(item.querySelector('.invoice-quantity').value) || 0;
            const price = parseFloat(item.querySelector('.invoice-price').value) || 0;
            const total = quantity * price;
            
            item.querySelector('.item-total').textContent = '‚Ç¶' + total.toFixed(2);
            calculateInvoiceTotal();
        }

        function calculateInvoiceTotal() {
            let total = 0;
            document.querySelectorAll('.invoice-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.invoice-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.invoice-price').value) || 0;
                total += quantity * price;
            });
            document.getElementById('invoice-total-amount').textContent = total.toFixed(2);
        }

        // Save invoice and create journal entry
        document.getElementById('invoice-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const items = [];
            let totalAmount = 0;

            document.querySelectorAll('.invoice-item').forEach(item => {
                const productSelect = item.querySelector('.invoice-product');
                const productId = productSelect.value;
                const quantity = parseFloat(item.querySelector('.invoice-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.invoice-price').value) || 0;
                const itemTotal = quantity * price;

                if (productId && quantity > 0) {
                    const product = products.find(p => p.id === productId);
                    items.push({
                        productId: productId,
                        productName: product.name,
                        quantity: quantity,
                        unitPrice: price,
                        total: itemTotal
                    });
                    totalAmount += itemTotal;
                }
            });

            if (items.length === 0) {
                alert('Please add at least one item to the invoice');
                return;
            }

            const invoiceData = {
                customer: document.getElementById('invoice-customer').value,
                date: new Date(document.getElementById('invoice-date').value),
                items: items,
                totalAmount: totalAmount,
                status: 'paid', // Assuming immediate payment for simplicity
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Save invoice
                const invoiceRef = await db.collection('companies').doc(COMPANY_ID).collection('invoices').add(invoiceData);
                
                // Generate invoice number
                await invoiceRef.update({
                    invoiceNumber: 'INV-' + invoiceRef.id.substring(0, 8).toUpperCase()
                });

                // Create journal entry for the sale
                const journalEntry = {
                    date: invoiceData.date,
                    reference: 'INV-' + invoiceRef.id.substring(0, 8).toUpperCase(),
                    description: 'Sales invoice for ' + invoiceData.customer,
                    lineItems: [
                        {
                            accountCode: '1001', // Cash
                            accountName: 'Cash',
                            accountType: 'asset',
                            debit: totalAmount,
                            credit: 0,
                            amount: totalAmount,
                            description: 'Sales revenue'
                        },
                        {
                            accountCode: '4001', // Medical Supplies Sales
                            accountName: 'Medical Supplies Sales',
                            accountType: 'revenue',
                            debit: 0,
                            credit: totalAmount,
                            amount: totalAmount,
                            description: 'Sales revenue'
                        }
                    ],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('companies').doc(COMPANY_ID).collection('journal_entries').add(journalEntry);

                // Update account balances
                await updateAccountBalance('1001', totalAmount, 0, 'asset');
                await updateAccountBalance('4001', 0, totalAmount, 'revenue');

                // Update inventory for each product
                for (const item of items) {
                    await updateProductInventory(item.productId, item.quantity, item.unitPrice);
                }

                alert('Invoice created successfully!');
                hideInvoiceForm();
                loadInvoices();
                loadSalesStats();
            } catch (error) {
                console.error('Error creating invoice:', error);
                alert('Error creating invoice: ' + error.message);
            }
        });

        async function updateProductInventory(productId, quantitySold, sellingPrice) {
            const productRef = db.collection('companies').doc(COMPANY_ID).collection('products').doc(productId);
            
            const doc = await productRef.get();
            const product = doc.data();
            
            const newStock = product.stockQuantity - quantitySold;
            const cogs = quantitySold * product.unitCost;

            await productRef.update({
                stockQuantity: newStock,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Record COGS journal entry
            if (cogs > 0) {
                const cogsEntry = {
                    date: new Date(),
                    reference: 'COGS-' + Date.now().toString().slice(-6),
                    description: 'Cost of goods sold for ' + product.name,
                    lineItems: [
                        {
                            accountCode: '5001', // COGS
                            accountName: 'Cost of Goods Sold',
                            accountType: 'expense',
                            debit: cogs,
                            credit: 0,
                            amount: cogs,
                            description: 'COGS for ' + product.name
                        },
                        {
                            accountCode: '1201', // Inventory
                            accountName: 'Inventory',
                            accountType: 'asset',
                            debit: 0,
                            credit: cogs,
                            amount: cogs,
                            description: 'Inventory reduction'
                        }
                    ],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('companies').doc(COMPANY_ID).collection('journal_entries').add(cogsEntry);

                // Update account balances for COGS
                await updateAccountBalance('5001', cogs, 0, 'expense');
                await updateAccountBalance('1201', 0, cogs, 'asset');
            }
        }

        async function updateAccountBalance(accountCode, debit, credit, accountType) {
            const accountRef = db.collection('companies').doc(COMPANY_ID).collection('chart_of_accounts').doc(accountCode);
            const doc = await accountRef.get();
            const currentBalance = doc.data().balance || 0;

            let newBalance = currentBalance;
            if (accountType === 'asset' || accountType === 'expense') {
                newBalance = currentBalance + debit - credit;
            } else {
                newBalance = currentBalance + credit - debit;
            }

            await accountRef.update({
                balance: newBalance,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function loadInvoices() {
            const tableBody = document.getElementById('invoices-table');
            
            db.collection('companies').doc(COMPANY_ID).collection('invoices')
                .orderBy('date', 'desc')
                .get()
                .then(snapshot => {
                    tableBody.innerHTML = '';
                    snapshot.forEach(doc => {
                        const invoice = doc.data();
                        const row = document.createElement('tr');
                        
                        const itemsText = invoice.items.map(item => 
                            item.quantity + 'x ' + item.productName
                        ).join(', ');
                        
                        row.innerHTML = '<td>' + (invoice.invoiceNumber || 'INV-' + doc.id.substring(0, 8).toUpperCase()) + '</td>' +
                            '<td>' + invoice.date.toDate().toLocaleDateString() + '</td>' +
                            '<td>' + invoice.customer + '</td>' +
                            '<td>‚Ç¶' + invoice.totalAmount.toLocaleString() + '</td>' +
                            '<td><span class="status-' + invoice.status + '">' + invoice.status + '</span></td>' +
                            '<td>' + itemsText + '</td>' +
                            '<td><button class="btn-secondary" onclick="viewInvoice(' + "'" + doc.id + "'" + ')">View</button></td>';
                        
                        tableBody.appendChild(row);
                    });
                });
        }

        function loadSalesStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            let totalToday = 0;
            let totalMonth = 0;
            let pendingCount = 0;
            let invoiceCount = 0;
            let totalAll = 0;

            db.collection('companies').doc(COMPANY_ID).collection('invoices')
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const invoice = doc.data();
                        const invoiceDate = invoice.date.toDate();
                        totalAll += invoice.totalAmount;
                        invoiceCount++;

                        if (invoiceDate >= today && invoiceDate < tomorrow) {
                            totalToday += invoice.totalAmount;
                        }
                        if (invoiceDate >= startOfMonth && invoiceDate <= endOfMonth) {
                            totalMonth += invoice.totalAmount;
                        }
                        if (invoice.status === 'pending') {
                            pendingCount++;
                        }
                    });

                    document.getElementById('sales-today').textContent = '‚Ç¶' + totalToday.toLocaleString();
                    document.getElementById('sales-month').textContent = '‚Ç¶' + totalMonth.toLocaleString();
                    document.getElementById('pending-invoices').textContent = pendingCount;
                    document.getElementById('average-invoice').textContent = '‚Ç¶' + (invoiceCount > 0 ? (totalAll / invoiceCount).toFixed(2) : '0');
                });
        }

        function viewInvoice(invoiceId) {
            // Implement view invoice details
            alert('View invoice: ' + invoiceId);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadInvoices();
            loadSalesStats();
        });
    </script>
</body>
                  </html>
